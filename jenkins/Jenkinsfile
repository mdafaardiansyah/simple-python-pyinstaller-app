// Menggunakan scripted pipeline syntax
node {
    def buildStatus = 'SUCCESS'
    
    try {
        stage('Preparation') {
            checkout scm
        }

        stage('Build') {
            docker.image('python:2-alpine').inside {
                sh '''
                    echo "Starting Build Stage..."
                    python -m py_compile ./sources/add2vals.py ./sources/calc.py
                    echo "Build Stage Completed"
                '''
            }
        }
        stage('Test') {
            docker.image('qnib/pytest').inside {
                sh '''
                    echo "Starting Test Stage..."
                    mkdir -p test-reports
                    py.test --verbose --junit-xml test-reports/results.xml ./sources/test_calc.py
                    echo "Test Stage Completed"
                '''
            }
        }
    } catch (Exception e) {
        buildStatus = 'FAILED'
        throw e
    } finally {
        echo "Build finished with status: ${buildStatus}"
    }
}